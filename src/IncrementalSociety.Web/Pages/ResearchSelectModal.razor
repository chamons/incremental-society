@using System.Collections.Immutable

@using IncrementalSociety.Web.Services
@using IncrementalSociety.Model
@using IncrementalSociety.Json

@inject IJSRuntime JsRuntime;
@inject GameService GameService

<div class="modal fade" id="selectResearchModal" tabindex="-1" role="dialog">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			@if (Enabled)
			{
				<div class="modal-header">
					<h5 class="modal-title">Research</h5>
					<button type="button" class="close" onclick=@OnCloseButton><span>&times;</span></button>
				</div>
				<div class="modal-body">
					@foreach (var researchItem in ResearchOptions) {
						var specializations = GameService.Engine.GetResearchSpecializations (researchItem.Name);
						if (specializations.Count == 0) {
							<ResearchView
								ResearchName=@researchItem.Name
								Description=@researchItem.Description
								Resources=@researchItem.Cost
								BackgroundStyle="@GetBackgroundStyle(researchItem.Name)"
								OnSelection=@(() => OnSelection (@researchItem.Name))
							/>
						}
						else {
							<div class="research-options">
								<div class="d-flex flex-wrap">
									<div class="research-title">@researchItem.Name</div>
									<MiniResourcesView AdditionalStyles="research-cost no-border" Resources="@researchItem.Cost" />
								</div>
								<div class="research-specializations">
									@for (int i = 0; i < specializations.Count; ++i) {
										int index = i;
										<ResearchView
											ResearchName=@specializations[index].Name
											Description=@specializations[i].Description
											BackgroundStyle="@GetBackgroundStyle(researchItem.Name, index)"
											OnSelection=@(() => OnSelection (researchItem.Name, index))
										/>
									}
								</div>
							</div>
						}

					}
				</div>
			}
		</div>
	</div>
</div>

@functions {
	bool Enabled => ResearchOptions != null;

	List<ResearchItem> ResearchOptions;

	bool CanResearch (string techName, int specializationIndex = -1) => GameService.Engine.CanResearch (GameService.State, techName, specializationIndex);
	string GetBackgroundStyle (string techName, int specializationIndex = -1) => CanResearch (techName, specializationIndex) ? "background-white" : "disabled";

	protected override void OnInit ()
	{
		GameService.CurrentUIStateChanged += OnUIStateChanged;
	}

	protected override void OnAfterRender ()
	{
		// Register for bootstrap notifications if not already done
		((IJSInProcessRuntime)JsRuntime).Invoke<object> ("InitResearchModal", new DotNetObjectRef(this));
	}

	void OnUIStateChanged (object sender, GameUIStateChangedEventArgs args)
	{
		// If we're just transisitioning to the dialog, consume the options and show it
		if (GameService.CurrentUIState == GameUIState.ShowResearchSelectDialog) {
			ResearchOptions = GameService.Engine.GetCurrentResearchOptions (GameService.State);
			StateHasChanged ();
			((IJSInProcessRuntime)JsRuntime).Invoke<object> ("ShowResearchModal");
		}
		StateHasChanged ();
	}

	void OnSelection (string techName, int specializationIndex = -1)
	{
		if (CanResearch (techName, specializationIndex)) {
			GameService.ApplyAction (ActionService.ResearchText, new string[] { techName, specializationIndex.ToString () });
			Dismiss (true);
		}
	}

	void Dismiss (bool closeDialog = false)
	{
		ResearchOptions = null;
		GameService.SetUIState (GameUIState.Default);
		if (closeDialog) {
			((IJSInProcessRuntime)JsRuntime).Invoke<object> ("DismissResearchModal");
		}
	}

	// Triggered with pressing the "X" button
	void OnCloseButton ()
	{
		Dismiss (true);
	}

	// Triggered when clicking off modal from bootstrap
	[JSInvokable]
	public void OnResearchModalDismissed ()
	{
		Dismiss ();
	}
}
